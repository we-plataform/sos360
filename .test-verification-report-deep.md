# Rate Limiting Test Verification for /leads/analyze-deep

## Subtask: subtask-4-3

### Date: 2026-01-27

## Implementation Verification ‚úÖ

### Middleware Applied

The `analyzeDeepRateLimit` middleware is correctly applied to the `/leads/analyze-deep` endpoint:

**File:** `apps/api/src/routes/leads.ts`
**Lines:** 378-383

```typescript
// POST /leads/analyze-deep - Deep behavioral analysis with Multimodal AI
leadsRouter.post(
  '/analyze-deep',
  authorize('owner', 'admin', 'manager', 'agent'),
  analyzeDeepRateLimit,  // ‚úÖ Line 382
  async (req, res, next) => {
```

### Middleware Configuration

**File:** `apps/api/src/middleware/rate-limit.ts`

```typescript
export const analyzeDeepRateLimit = rateLimit({
  windowMs: RATE_LIMITS.analyzeDeep.windowMs, // 60000ms (1 minute)
  max: RATE_LIMITS.analyzeDeep.max, // 10 requests
  message: {
    success: false,
    error: {
      type: "rate_limited",
      title: "Too Many Requests",
      status: 429,
      detail: "Muitas an√°lises profundas. Tente novamente em alguns minutos.",
    },
  },
  standardHeaders: true,
  legacyHeaders: false,
  keyGenerator: (req) => {
    // Use user ID if authenticated, otherwise use IP
    if (req.user?.id) {
      return `user:${req.user.id}:analyze-deep`;
    }
    const ip = getClientIp(req);
    return `ip:${ip}:analyze-deep`;
  },
  skip: (req) => {
    // Skip if we can't determine identity
    if (req.user?.id) return false;
    const ip = getClientIp(req);
    return ip === "unknown";
  },
});
```

### Rate Limit Constants

**File:** `packages/shared/src/constants/index.ts`

```typescript
analyzeDeep: { max: 10, windowMs: 60000 }
```

**Limit:** 10 requests per minute

**Why Stricter Than Regular Analyze?**

- Deep analysis uses **gpt-4o with vision capabilities**
- Vision model is significantly more expensive than gpt-4o-mini
- Each request can process multiple post images
- Images + text = higher token consumption and cost
- 10/min limit balances utility with cost protection
- Still allows meaningful deep analysis work while preventing abuse

**Cost Comparison:**

```
Regular /analyze (gpt-4o-mini):
- 20/min √ó 1 profile = 20 profiles/minute
- Low cost per analysis

Deep /analyze-deep (gpt-4o with vision):
- 10/min √ó 1 profile = 10 profiles/minute
- Vision model: ~10-20x more expensive than gpt-4o-mini
- Image processing adds significant cost
- Therefore: 2x stricter rate limit (10 vs 20)
```

## Test Methodology

### Automated Tests Created

1. **`.test-rate-limit-analyze-deep.js`** - Basic test without authentication
   - Tests IP-based rate limiting
   - Sends 11 requests (10 + 1 to trigger limit)
   - Expects 401 for unauthorized, 429 for rate limited

2. **`.test-rate-limit-analyze-deep-auth.js`** - Test with user registration/login
   - Registers a new user
   - Logs in to get auth token
   - Sends authenticated deep analysis requests
   - Tests user-based rate limiting

### Manual Testing Instructions

#### Option 1: Using Existing User Session

```bash
# 1. Login to get auth token
TOKEN=$(curl -s -X POST http://localhost:3001/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"your-email@example.com","password":"your-password"}' \
  | jq -r '.data.tokens.accessToken')

# 2. Send 11 deep analysis requests rapidly (faster than 1 minute)
for i in {1..11}; do
  echo "Request $i:"
  curl -X POST http://localhost:3001/api/v1/leads/analyze-deep \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer $TOKEN" \
    -d '{
      "leadId": "test-'$i'",
      "profile": {
        "username": "testuser-'$i'",
        "platform": "instagram",
        "bio": "Test bio"
      },
      "posts": [
        {
          "content": "Test post content",
          "likes": 100,
          "comments": 10
        }
      ]
    }' \
    -w "\nStatus: %{http_code}\n" \
    2>/dev/null | head -20
  echo "---"
  sleep 0.1
done
```

**Expected Result:**

- Requests 1-10: Return 200, 400, or 500 (depending on OpenAI status)
- Request 11: Returns **429** with message:
  ```json
  {
    "success": false,
    "error": {
      "type": "rate_limited",
      "title": "Too Many Requests",
      "status": 429,
      "detail": "Muitas an√°lises profundas. Tente novamente em alguns minutos."
    }
  }
  ```

#### Option 2: One-Liner Test (with valid token)

```bash
# Replace YOUR_TOKEN with actual JWT
TOKEN="YOUR_TOKEN"

# Send 11 deep analysis requests
for i in {1..11}; do
  STATUS=$(curl -s -X POST http://localhost:3001/api/v1/leads/analyze-deep \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer $TOKEN" \
    -d '{
      "leadId": "test-'$i'",
      "profile": {"username": "testuser", "platform": "instagram"},
      "posts": [{"content": "test", "likes": 10}]
    }' \
    -w "%{http_code}" -o /dev/null)
  echo "Request $i: $STATUS"
  [ "$STATUS" = "429" ] && echo "‚úÖ Rate limiting triggered!" && break
  sleep 0.05
done
```

#### Option 3: Interactive Test with Browser DevTools

1. Login to the Lia360 web application
2. Open DevTools ‚Üí Console
3. Get auth token from localStorage:
   ```javascript
   const token = localStorage.getItem("accessToken");
   ```
4. Run in console:
   ```javascript
   async function testDeepAnalysisRateLimit() {
     for (let i = 1; i <= 11; i++) {
       const res = await fetch(
         "http://localhost:3001/api/v1/leads/analyze-deep",
         {
           method: "POST",
           headers: {
             "Content-Type": "application/json",
             Authorization: `Bearer ${token}`,
           },
           body: JSON.stringify({
             leadId: `test-${i}`,
             profile: {
               username: `testuser-${i}`,
               platform: "instagram",
               bio: "Test bio for deep analysis",
             },
             posts: [
               {
                 content: "Test post content",
                 likes: 100,
                 comments: 10,
               },
             ],
           }),
         },
       );
       console.log(`Request ${i}: ${res.status}`);
       if (res.status === 429) {
         console.log("‚úÖ Rate limited!");
         const data = await res.json();
         console.log("Error:", data.error);
         break;
       }
       await new Promise((r) => setTimeout(r, 50));
     }
   }
   testDeepAnalysisRateLimit();
   ```

#### Option 4: Test with Multiple Posts

The deep analysis endpoint processes multiple posts with vision:

```bash
TOKEN="YOUR_TOKEN"

# Send deep analysis with multiple posts (more data to process)
curl -X POST http://localhost:3001/api/v1/leads/analyze-deep \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "leadId": "test-multiple-posts",
    "profile": {
      "username": "testuser",
      "platform": "instagram",
      "bio": "Test user with multiple posts"
    },
    "posts": [
      {
        "content": "First post about product",
        "likes": 150,
        "comments": 20
      },
      {
        "content": "Second post with engagement",
        "likes": 200,
        "comments": 35
      },
      {
        "content": "Third post viral content",
        "likes": 500,
        "comments": 80
      }
    ]
  }'
```

**Note:** Each deep analysis request processes all posts using the vision model, making it significantly more expensive than regular analysis.

## Verification Status

### ‚úÖ Implementation Verified

- [x] Middleware correctly defined in `rate-limit.ts`
- [x] Middleware correctly imported in `leads.ts`
- [x] Middleware correctly applied to `/leads/analyze-deep` route (line 382)
- [x] Rate limit constants correctly defined (10/min - stricter than analyze)
- [x] Follows existing patterns (same as `analyzeRateLimit`, `analyzeBatchRateLimit`)
- [x] Uses user ID when authenticated, IP otherwise
- [x] Returns proper 429 error with Portuguese message

### ‚ö†Ô∏è End-to-End Testing

- [ ] Full E2E test with valid authentication token
  - Requires existing user with valid credentials
  - Or working registration flow with all required fields

### üìù Notes

1. **Middleware Order**: Rate limiter is positioned AFTER authorization
   - This follows the existing pattern (same as `/leads/analyze` and `/leads/analyze-batch`)
   - Unauthenticated requests are rejected with 401 before rate limiting
   - Only authenticated users are rate limited
   - This is acceptable design - prevents unauthenticated abuse

2. **Rate Limit Behavior**:
   - Window: 60 seconds (rolling window)
   - Max requests: 10 (stricter than analyze which is 20/min)
   - Key: `user:{userId}:analyze-deep` or `ip:{ip}:analyze-deep`
   - Resets: Gradually as requests age out of the window

3. **Stricter Limit Rationale**:

   ```
   Model Cost Comparison:
   - Regular /analyze: gpt-4o-mini (cheap)
   - Deep /analyze-deep: gpt-4o with vision (expensive)

   Vision Model Cost Factors:
   - Image processing: ~10-20x more expensive than text
   - Multiple posts per request = multiple images
   - Higher token consumption
   - Therefore: 2x stricter rate limit (10 vs 20)
   ```

4. **Use Cases for Deep Analysis**:
   - High-value leads requiring detailed behavioral analysis
   - Influencer vetting and qualification
   - Content strategy analysis from post history
   - Engagement pattern recognition
   - Not needed for every lead - selective use is expected

5. **Error Response**:

   ```json
   {
     "success": false,
     "error": {
       "type": "rate_limited",
       "title": "Too Many Requests",
       "status": 429,
       "detail": "Muitas an√°lises profundas. Tente novamente em alguns minutos."
     }
   }
   ```

6. **Rate Limit Headers** (when rate limited):
   - `RateLimit-Limit`: 10
   - `RateLimit-Remaining`: 0
   - `RateLimit-Reset`: Unix timestamp

7. **Vision Model Cost Protection**:
   - Each deep analysis request can process up to dozens of posts
   - Each post with images requires vision model processing
   - Without rate limiting, a user could rack up significant costs
   - 10/min limit allows 600 deep analyses/hour maximum
   - For high-volume needs, users should batch and prioritize leads

## Conclusion

The rate limiting middleware for `/leads/analyze-deep` endpoint is **correctly implemented and applied**. The implementation follows existing patterns in the codebase and will function correctly for authenticated users.

The stricter rate limit (10/min vs 20/min for regular analyze) is appropriate given the cost implications - each deep analysis request uses the expensive gpt-4o vision model to process posts with images, making it significantly more expensive than a single profile analysis with gpt-4o-mini.

Full end-to-end testing requires a valid authentication token from an existing user session. The manual testing instructions above can be used to verify the 429 response is returned when the rate limit is exceeded.

**Status:** ‚úÖ Implementation verified - Ready for manual testing with authentication
