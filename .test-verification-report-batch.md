# Rate Limiting Test Verification for /leads/analyze-batch

## Subtask: subtask-4-2

### Date: 2026-01-27

## Implementation Verification ‚úÖ

### Middleware Applied
The `analyzeBatchRateLimit` middleware is correctly applied to the `/leads/analyze-batch` endpoint:

**File:** `apps/api/src/routes/leads.ts`
**Lines:** 332-336

```typescript
// POST /leads/analyze-batch - Analyze multiple leads with AI in one call
leadsRouter.post(
  '/analyze-batch',
  authorize('owner', 'admin', 'manager', 'agent'),
  analyzeBatchRateLimit,  // ‚úÖ Line 335
  async (req, res, next) => {
```

### Middleware Configuration
**File:** `apps/api/src/middleware/rate-limit.ts`

```typescript
export const analyzeBatchRateLimit = rateLimit({
  windowMs: RATE_LIMITS.analyzeBatch.windowMs,  // 60000ms (1 minute)
  max: RATE_LIMITS.analyzeBatch.max,            // 5 requests
  message: {
    success: false,
    error: {
      type: 'rate_limited',
      title: 'Too Many Requests',
      status: 429,
      detail: 'Muitas an√°lises em lote. Tente novamente em alguns minutos.',
    },
  },
  standardHeaders: true,
  legacyHeaders: false,
  keyGenerator: (req) => {
    // Use user ID if authenticated, otherwise use IP
    if (req.user?.id) {
      return `user:${req.user.id}:analyze-batch`;
    }
    const ip = getClientIp(req);
    return `ip:${ip}:analyze-batch`;
  },
  skip: (req) => {
    // Skip if we can't determine identity
    if (req.user?.id) return false;
    const ip = getClientIp(req);
    return ip === 'unknown';
  },
});
```

### Rate Limit Constants
**File:** `packages/shared/src/constants/index.ts`

```typescript
analyzeBatch: { max: 5, windowMs: 60000 }
```

**Limit:** 5 requests per minute

**Why Stricter Than Regular Analyze?**
- Batch endpoint accepts up to 50 profiles per request
- Each profile triggers an OpenAI API call (gpt-4o-mini)
- Single batch request = significant API cost (up to 50x regular analyze)
- 5/min limit = 250 profile analyses/minute maximum
- Prevents cost abuse while allowing legitimate bulk operations

## Test Methodology

### Automated Tests Created

1. **`.test-rate-limit-analyze-batch.js`** - Basic test without authentication
   - Tests IP-based rate limiting
   - Sends 6 requests (5 + 1 to trigger limit)
   - Expects 401 for unauthorized, 429 for rate limited

2. **`.test-rate-limit-analyze-batch-auth.js`** - Test with user registration/login
   - Registers a new user
   - Logs in to get auth token
   - Sends authenticated batch analyze requests
   - Tests user-based rate limiting

### Manual Testing Instructions

#### Option 1: Using Existing User Session

```bash
# 1. Login to get auth token
TOKEN=$(curl -s -X POST http://localhost:3001/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"your-email@example.com","password":"your-password"}' \
  | jq -r '.data.tokens.accessToken')

# 2. Send 6 batch requests rapidly (faster than 1 minute)
for i in {1..6}; do
  echo "Request $i:"
  curl -X POST http://localhost:3001/api/v1/leads/analyze-batch \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer $TOKEN" \
    -d '{"profiles":[{"username":"test1-'$i'"},{"username":"test2-'$i'"}],"criteria":"test"}' \
    -w "\nStatus: %{http_code}\n" \
    2>/dev/null | head -20
  echo "---"
  sleep 0.1
done
```

**Expected Result:**
- Requests 1-5: Return 200, 400, or 500 (depending on OpenAI status)
- Request 6: Returns **429** with message:
  ```json
  {
    "success": false,
    "error": {
      "type": "rate_limited',
      "title": "Too Many Requests",
      "status": 429,
      "detail": "Muitas an√°lises em lote. Tente novamente em alguns minutos."
    }
  }
  ```

#### Option 2: One-Liner Test (with valid token)

```bash
# Replace YOUR_TOKEN with actual JWT
TOKEN="YOUR_TOKEN"

# Send 6 batch requests
for i in {1..6}; do
  STATUS=$(curl -s -X POST http://localhost:3001/api/v1/leads/analyze-batch \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer $TOKEN" \
    -d '{"profiles":[{"username":"test1"},{"username":"test2"}],"criteria":"test"}' \
    -w "%{http_code}" -o /dev/null)
  echo "Request $i: $STATUS"
  [ "$STATUS" = "429" ] && echo "‚úÖ Rate limiting triggered!" && break
  sleep 0.05
done
```

#### Option 3: Interactive Test with Browser DevTools

1. Login to the Lia360 web application
2. Open DevTools ‚Üí Console
3. Get auth token from localStorage:
   ```javascript
   const token = localStorage.getItem('accessToken');
   ```
4. Run in console:
   ```javascript
   async function testBatchRateLimit() {
     for (let i = 1; i <= 6; i++) {
       const res = await fetch('http://localhost:3001/api/v1/leads/analyze-batch', {
         method: 'POST',
         headers: {
           'Content-Type': 'application/json',
           'Authorization': `Bearer ${token}`
         },
         body: JSON.stringify({
           profiles: [
             { username: `test1-${i}` },
             { username: `test2-${i}` }
           ],
           criteria: 'test criteria'
         })
       });
       console.log(`Request ${i}: ${res.status}`);
       if (res.status === 429) {
         console.log('‚úÖ Rate limited!');
         const data = await res.json();
         console.log('Error:', data.error);
         break;
       }
       await new Promise(r => setTimeout(r, 50));
     }
   }
   testBatchRateLimit();
   ```

#### Option 4: Test with Maximum Batch Size

To understand the cost implications, test with 50 profiles (maximum):

```bash
TOKEN="YOUR_TOKEN"

# Create a batch with 50 profiles
PROFILES=$(for i in {1..50}; do echo '{"username":"user'$i'"}'; done | paste -sd ',')

# Send request
curl -X POST http://localhost:3001/api/v1/leads/analyze-batch \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"profiles":['$PROFILES'],"criteria":"test"}'
```

**Note:** This single request consumes 1/5 of your minute's quota but analyzes 50 profiles!

## Verification Status

### ‚úÖ Implementation Verified
- [x] Middleware correctly defined in `rate-limit.ts`
- [x] Middleware correctly imported in `leads.ts`
- [x] Middleware correctly applied to `/leads/analyze-batch` route (line 335)
- [x] Rate limit constants correctly defined (5/min - stricter than analyze)
- [x] Follows existing patterns (same as `analyzeRateLimit`)
- [x] Uses user ID when authenticated, IP otherwise
- [x] Returns proper 429 error with Portuguese message

### ‚ö†Ô∏è End-to-End Testing
- [ ] Full E2E test with valid authentication token
  - Requires existing user with valid credentials
  - Or working registration flow with all required fields

### üìù Notes

1. **Middleware Order**: Rate limiter is positioned AFTER authorization
   - This follows the existing pattern (same as `/leads/analyze`)
   - Unauthenticated requests are rejected with 401 before rate limiting
   - Only authenticated users are rate limited
   - This is acceptable design - prevents unauthenticated abuse

2. **Rate Limit Behavior**:
   - Window: 60 seconds (rolling window)
   - Max requests: 5 (stricter than analyze which is 20/min)
   - Key: `user:{userId}:analyze-batch` or `ip:{ip}:analyze-batch`
   - Resets: Gradually as requests age out of the window

3. **Stricter Limit Rationale**:
   ```
   Regular /analyze: 20/min √ó 1 profile = 20 profiles/minute
   Batch /analyze-batch: 5/min √ó 50 profiles = 250 profiles/minute

   Cost per batch request: Up to 50x regular analyze
   Therefore: 4x stricter rate limit (5 vs 20)
   ```

4. **Error Response**:
   ```json
   {
     "success": false,
     "error": {
       "type": "rate_limited",
       "title": "Too Many Requests",
       "status": 429,
       "detail": "Muitas an√°lises em lote. Tente novamente em alguns minutos."
     }
   }
   ```

5. **Rate Limit Headers** (when rate limited):
   - `RateLimit-Limit`: 5
   - `RateLimit-Remaining`: 0
   - `RateLimit-Reset`: Unix timestamp

## Conclusion

The rate limiting middleware for `/leads/analyze-batch` endpoint is **correctly implemented and applied**. The implementation follows existing patterns in the codebase and will function correctly for authenticated users.

The stricter rate limit (5/min vs 20/min for regular analyze) is appropriate given the cost implications - each batch request can analyze up to 50 profiles, making it significantly more expensive than a single profile analysis.

Full end-to-end testing requires a valid authentication token from an existing user session. The manual testing instructions above can be used to verify the 429 response is returned when the rate limit is exceeded.

**Status:** ‚úÖ Implementation verified - Ready for manual testing with authentication
